## 状态关系单子
在之前的 [[PLC-11-MonadHoare]] 中，我们介绍了集合单子上的霍尔逻辑（退化为霍尔二元组）。

本章介绍状态关系单子上的霍尔逻辑。

与集合单子（Set Monad）不同，在状态关系单子上，霍尔逻辑重新回归为标准的**霍尔三元组** ${ P } c { Q }$，其具体定义为： $$ \text{Hoare}(P, c, Q) \triangleq \forall s_1, a, s_2, ~ P(s_1) \to (s_1, a, s_2) \in c \to Q(a, s_2) $$

由于状态关系单子表示“**带有程序状态的非确定性计算**”，这个定义的意思是：

> 如果初始状态 $s_1$ 满足前条件 $P$，且计算 $c$ 将状态从 $s_1$ 转变为 $s_2$ 并返回结果 $a$，那么结果 $a$ 与最终状态 $s_2$ 必须共同满足性质 $Q$。

问题又来了：为什么在状态关系单子上，霍尔逻辑从“二元组”回到了“三元组”？

让我们看一下一状态关系单子的定义： $$ M(\Sigma, A) \triangleq \Sigma \to A \to \Sigma \to \text{Prop} $$ 对于一个计算 $c \in M(\Sigma, A)$，它不再是一个静态的集合，而是一个**三元关系**。它的含义是：给定一个输入状态 $\Sigma$，它可能产生哪些结果 $A$ 以及相应的新状态 $\Sigma$。

**逻辑内涵：** 在集合单子中，计算不依赖于环境，因此不需要前条件。但在状态关系单子中，计算 $c$ 的行为（即它能到达哪些 $a$ 和 $s_2$）是**依赖于初始状态 $s_1$ 的**。因此，我们必须使用**前条件 $P$** 来约束初始状态，才能对计算后的结果做出保证。这就是为什么霍尔三元组在处理带状态的计算时是必不可少的。

## 状态关系单子的核心逻辑规则

基于上述定义，状态关系单子上的算子满足以下霍尔逻辑推理规则：

1. **顺序组合规则 (Hoare_bind)**： 若 $\{P\} f \{Q\}$ 且对于所有的返回结果 $a$，都有 $\{Q(a)\} g(a) \{R\}$，则 $\{P\} (x \leftarrow f ;; g(x)) \{R\}$。 _这表明中间状态的性质 $Q$ 充当了前一个计算的后条件和后一个计算的前条件。_
    
2. **返回规则 (Hoare_ret)**： 对于任意关于结果和状态的性质 $Q$，只要初始状态满足 $Q(a_0)$，那么直接返回 $a_0$ 的计算满足 $\{Q(a_0)\} \text{ret}(a_0) \{Q\}$。
    
3. **非确定性选择规则 (Hoare_choice)**： 如果计算 $f$ 和 $g$ 在相同的前条件下都能满足后条件 $Q$，那么它们的非确定性选择 $f \cup g$ 也满足该条件。
    
4. **循环规则 (Hoare_repeat_break)**： 设定 $P$ 为**循环不变量**。如果循环体 `body` 在满足 $P$ 的状态下执行后，若继续循环则保持 $P$，若跳出循环则满足 $Q$，那么整个循环计算在初始满足 $P$ 时，结束一定满足 $Q$。
    

## 扩展应用：图的可达性

在理论的最后，本章引入了**有向图（PreGraph）** 的概念，将程序行为抽象为图上的“步进”（step）。

- **多步可达性（reachable）**：定义为单步关系的自反传递闭包。
- 这为验证复杂的算法（如路径搜索或状态机）提供了统一的数学描述，即将程序的正确性转化为图节点之间的可达性证明。

---

**打个比方：** 如果**集合单子**是“从一个百宝箱里摸东西”（东西就在那，跟你的心情无关），那么**状态关系单子**就是“玩一场大富翁游戏”。

- **计算 $c$**：是掷一次骰子。
- **前条件 $P$**：是你掷骰子前落在哪一格（初始状态）。
- **后条件 $Q$**：是你掷完后停留的位置和手里的钱。 因为你掷完后的处境（$Q$）完全取决于你出发时的位置（$P$），所以我们必须用“三元组”来描述这场游戏的规则。